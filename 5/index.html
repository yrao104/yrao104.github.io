<!DOCTYPE html>
<html>
<head>
    <title>CS 180 Project 5</title>
    <style>
        body {
            font-family: Georgia, sans-serif;
            margin: 20px;
            text-align: center;
            background: radial-gradient(circle,rgba(238, 174, 202, 1) 0%, rgba(148, 187, 233, 1) 100%);
        }

        h1 {
            margin-bottom: 30px;
            margin-top: 60px;
        }

        h2 {
            margin-bottom: 20px;
            margin-top: 0px;
        }

        .info {
            margin-left: auto;
            margin-right: auto;
            width: 80%;
            border-radius: 8px;
            text-align: left;
            background: #e6e0f5;
            padding: 50px;
        }

        .container {
            text-align: center;
            max-width: 50%;
        }

        .solo-row .container {
            max-width: 60%;
        }

        .container img {
            height: 300px;
            width: auto;
        }

        hr {
            margin-top: 40px;
            margin-bottom: 40px; 
        }

        .caption {
            font-size: 15px;
            margin-top: 5px;
        }

        .row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        p {
            margin-top: 30px;
            margin-bottom: 30px;
            margin-right: 15px;
            margin-left: 15px;
        }

        .stack-image-container {
            width: 100%;
            text-align: center;
        }

        .stack-image-container img {
            width: 90%;
            height: auto;
            margin-bottom: 5px;
        }

    </style>
</head>
<body>
    <h1>Project #5: Fun With Diffusion Models!</h1>

    <h2 style="margin-bottom: 50px">Part A: The Power of Diffusion Models</h2>

    <div class="info">

        <h2>Part 0: Setup</h2>

        <p style="text-align: left;">
            In this part, I created my own text prompts to generate the corresponding prompt embeddings.
            Using these embeddings, I choose 3 of the prompts to generate images with the DeepFloyd model.
            I used a random seed of 180 and generated images using num_inference_step values of 20 and 120.
            Overall, the generated images matched the prompt text well.
            Increasing num_inference_steps from 20 to 120 significantly improved image quality with much more fine detail present in the images as shown below. 
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part01.png" style="height: 150px; width: auto;">
                <div class="caption">"a photo of a family of ducks", num_inference_steps=20</div>
            </div>
            <div class="container">
                <img src="./media/part02.png" style="height: 150px; width: auto;">
                <div class="caption">"sunset over a forest", num_inference_steps=20</div>
            </div>
            <div class="container">
                <img src="./media/part03.png" style="height: 150px; width: auto;">
                <div class="caption">"an oil painting of snow on a beach", num_inference_steps=20</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part04.png" style="height: 150px; width: auto;">
                <div class="caption">"a photo of a family of ducks", num_inference_steps=120</div>
            </div>
            <div class="container">
                <img src="./media/part05.png" style="height: 150px; width: auto;">
                <div class="caption">"sunset over a forest", num_inference_steps=120</div>
            </div>
            <div class="container">
                <img src="./media/part06.png" style="height: 150px; width: auto;">
                <div class="caption">"an oil painting of snow on a beach", num_inference_steps=120</div>
            </div>
        </div>

        <hr />

        <h1>Part 1: Sampling Loops</h1>

        <h2>Part 1.1: Implementing the Forward Process</h2>

        <p style="text-align: left;">
             In this part, I implemented the forward(im, t) function to add Gaussian noise to the given image using torch.randn_like.
             Below is the test image of the Campanile at noise levels 250, 500, and 750.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.11.png" style="height: 150px; width: auto;">
                <div class="caption">Berkeley Campanile</div>
            </div>
            <div class="container">
                <img src="./media/part1.12.png" style="height: 150px; width: auto;">
                <div class="caption">Noisy Campanile @ t=250</div>
            </div>
             <div class="container">
                <img src="./media/part1.13.png" style="height: 150px; width: auto;">
                <div class="caption">Noisy Campanile @ t=500</div>
            </div>
            <div class="container">
                <img src="./media/part1.14.png" style="height: 150px; width: auto;">
                <div class="caption">Noisy Campanile @ t=750</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.2: Classical Denoising</h2>

        <p style="text-align: left;">
            In this part, I used Gaussian blur filtering to denoise the given noisy images.
            Below are the images from the previous part with the Gaussian-denoised images below.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.12.png" style="height: 200px; width: auto;">
                <div class="caption">Noisy Campanile @ t=250</div>
            </div>
            <div class="container">
                <img src="./media/part1.13.png" style="height: 200px; width: auto;">
                <div class="caption">Noisy Campanile @ t=500</div>
            </div>
            <div class="container">
                <img src="./media/part1.14.png" style="height: 200px; width: auto;">
                <div class="caption">Noisy Campanile @ t=750</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.21.png" style="height: 200px; width: auto;">
                <div class="caption">Gaussian Denoising @ t=250</div>
            </div>
            <div class="container">
                <img src="./media/part1.22.png" style="height: 200px; width: auto;">
                <div class="caption">Gaussian Denoising @ t=500</div>
            </div>
            <div class="container">
                <img src="./media/part1.23.png" style="height: 200px; width: auto;">
                <div class="caption">Gaussian Denoising @ t=750</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.3: One-Step Denoising</h2>

        <p style="text-align: left;">
            In this part, I denoised images using a pretrained diffusion model instead.
            The model retrieves the Gaussian noise present in the image and then removes it to get the original image.
            Below are the images from part 1.1 with the diffusion model denoised images below. 
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.12.png" style="height: 200px; width: auto;">
                <div class="caption">Noisy Campanile @ t=250</div>
            </div>
            <div class="container">
                <img src="./media/part1.13.png" style="height: 200px; width: auto;">
                <div class="caption">Noisy Campanile @ t=500</div>
            </div>
            <div class="container">
                <img src="./media/part1.14.png" style="height: 200px; width: auto;">
                <div class="caption">Noisy Campanile @ t=750</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.31.png" style="height: 200px; width: auto;">
                <div class="caption">One-Step Denoised Campanile @ t=250</div>
            </div>
            <div class="container">
                <img src="./media/part1.32.png" style="height: 200px; width: auto;">
                <div class="caption">One-Step Denoised Campanile @ t=500</div>
            </div>
            <div class="container">
                <img src="./media/part1.33.png" style="height: 200px; width: auto;">
                <div class="caption">One-Step Denoised Campanile @ t=750</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.4: Iterative Denoising</h2>

        <p style="text-align: left;">
            In this part, I used the equations present in the Denoising Diffusion Probabilistic Models paper to iteratively denoise an image starting at i_start across strided timesteps.
            Below is the noisy image every 5th denoising loop as well as the comparisons between the original, iterative denoising, one-step denoising, and Gaussian blurred images.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.41.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy Campanile @ t=90</div>
            </div>
            <div class="container">
                <img src="./media/part1.42.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy Campanile @ t=240</div>
            </div>
             <div class="container">
                <img src="./media/part1.43.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy Campanile @ t=390</div>
            </div>
            <div class="container">
                <img src="./media/part1.44.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy Campanile @ t=540</div>
            </div>
            <div class="container">
                <img src="./media/part1.45.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy Campanile @ t=690</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.46.png" style="height: 100px; width: auto;">
                <div class="caption">Original</div>
            </div>
            <div class="container">
                <img src="./media/part1.47.png" style="height: 100px; width: auto;">
                <div class="caption">Iteratively Denoised Campanile</div>
            </div>
             <div class="container">
                <img src="./media/part1.48.png" style="height: 100px; width: auto;">
                <div class="caption">One-Step Denoised Campanile</div>
            </div>
            <div class="container">
                <img src="./media/part1.49.png" style="height: 100px; width: auto;">
                <div class="caption">Gaussian Blurred Campanile</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.5: Diffusion Model Sampling</h2>

        <p style="text-align: left;">
            In this part, I sampled 5 images from the diffusion model with i_start=0 and random noise.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.51.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 1</div>
            </div>
            <div class="container">
                <img src="./media/part1.52.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 2</div>
            </div>
             <div class="container">
                <img src="./media/part1.53.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 3</div>
            </div>
            <div class="container">
                <img src="./media/part1.54.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 4</div>
            </div>
            <div class="container">
                <img src="./media/part1.55.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 5</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.6: Classifier-Free Guidance (CFG)</h2>

        <p style="text-align: left;">
            In this part, I implemented the iterative_denoise_cfg function similar to the iterative_denoise function but with classifier-free guidance.
            To do this, I used the stage_1.unet function twice to get the conditional noise estimate as well as the unconditional noise estimate to then use for the calculation of the new noise estimate.
            Then, I sampled 5 images from the diffusion model using this iterative_denoise_cfg function.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.61.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 1 w/ CFG</div>
            </div>
            <div class="container">
                <img src="./media/part1.62.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 2 w/ CFG</div>
            </div>
             <div class="container">
                <img src="./media/part1.63.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 3 w/ CFG</div>
            </div>
            <div class="container">
                <img src="./media/part1.64.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 4 w/ CFG</div>
            </div>
            <div class="container">
                <img src="./media/part1.65.png" style="height: 100px; width: auto;">
                <div class="caption">Sample 5 w/ CFG</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.7: Image-to-image Translation</h2>

        <p style="text-align: left;">
            In this part, I ran the forward function to get a noisy image and then called iterative_denoise_cfg with steps [1, 3, 5, 7, 10, 20] to slowly apply "edits" to the original image.
            We can see below that as the steps increase, the output starts to look more like the original image.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.71.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=1</div>
            </div>
            <div class="container">
                <img src="./media/part1.72.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=3</div>
            </div>
             <div class="container">
                <img src="./media/part1.73.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=5</div>
            </div>
            <div class="container">
                <img src="./media/part1.74.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=7</div>
            </div>
            <div class="container">
                <img src="./media/part1.75.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=10</div>
            </div>
            <div class="container">
                <img src="./media/part1.76.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=20</div>
            </div>
            <div class="container">
                <img src="./media/part1.77.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile (Original)</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.78.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=1</div>
            </div>
            <div class="container">
                <img src="./media/part1.79.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=3</div>
            </div>
             <div class="container">
                <img src="./media/part1.710.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=5</div>
            </div>
            <div class="container">
                <img src="./media/part1.711.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=7</div>
            </div>
            <div class="container">
                <img src="./media/part1.712.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=10</div>
            </div>
            <div class="container">
                <img src="./media/part1.713.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=20</div>
            </div>
            <div class="container">
                <img src="./media/part1.714.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View (Original)</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.715.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=1</div>
            </div>
            <div class="container">
                <img src="./media/part1.716.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=3</div>
            </div>
             <div class="container">
                <img src="./media/part1.717.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=5</div>
            </div>
            <div class="container">
                <img src="./media/part1.718.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=7</div>
            </div>
            <div class="container">
                <img src="./media/part1.719.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=10</div>
            </div>
            <div class="container">
                <img src="./media/part1.720.png" style="height: 75px; width: auto;">
                <div class="caption">SDEdit w/ i_start=20</div>
            </div>
            <div class="container">
                <img src="./media/part1.721.png" style="height: 75px; width: auto;">
                <div class="caption">Garden (Original)</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.7.1: Editing Hand-Drawn and Web Images</h2>

        <p style="text-align: left;">
            In this part, I ran the same method as the previous section with steps [1, 3, 5, 7, 10, 20] to slowly apply "edits" to the original image.
            This time, I used images that I drew as well as web images to project them onto the natural image manifold, leveraging the diffusion model.
            Once again, we can see below that as the steps increase, the output starts to look more like the original image and more realistic.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.11.png" style="height: 75px; width: auto;">
                <div class="caption">Lion at i_start=1</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.12.png" style="height: 75px; width: auto;">
                <div class="caption">Lion at i_start=3</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.13.png" style="height: 75px; width: auto;">
                <div class="caption">Lion at i_start=5</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.14.png" style="height: 75px; width: auto;">
                <div class="caption">Lion at i_start=7</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.15.png" style="height: 75px; width: auto;">
                <div class="caption">Lion at i_start=10</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.16.png" style="height: 75px; width: auto;">
                <div class="caption">Lion at i_start=20</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.17.png" style="height: 75px; width: auto;">
                <div class="caption">Lion (Original)</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.18.png" style="height: 75px; width: auto;">
                <div class="caption">Flower at i_start=1</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.19.png" style="height: 75px; width: auto;">
                <div class="caption">Flower at i_start=3</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.110.png" style="height: 75px; width: auto;">
                <div class="caption">Flower at i_start=5</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.111.png" style="height: 75px; width: auto;">
                <div class="caption">Flower at i_start=7</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.112.png" style="height: 75px; width: auto;">
                <div class="caption">Flower at i_start=10</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.113.png" style="height: 75px; width: auto;">
                <div class="caption">Flower at i_start=20</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.114.png" style="height: 75px; width: auto;">
                <div class="caption">Flower (Original)</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.115.png" style="height: 75px; width: auto;">
                <div class="caption">Tree at i_start=1</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.116.png" style="height: 75px; width: auto;">
                <div class="caption">Tree at i_start=3</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.117.png" style="height: 75px; width: auto;">
                <div class="caption">Tree at i_start=5</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.118.png" style="height: 75px; width: auto;">
                <div class="caption">Tree at i_start=7</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.119.png" style="height: 75px; width: auto;">
                <div class="caption">Tree at i_start=10</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.120.png" style="height: 75px; width: auto;">
                <div class="caption">Tree at i_start=20</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.121.png" style="height: 75px; width: auto;">
                <div class="caption">Tree (Original)</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.7.2: Inpainting</h2>

        <p style="text-align: left;">
            In this part, I followed the same procedure as the previous iterative_denoise_cfg function, but I incorporated a binary mask to only generate new content where the mask=1 and keep the same content where the mask=0.
            I used the update step for x_t from the RePaint paper to implement this mask modification at each denoising step.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.21.png" style="height: 150px; width: auto;">
                <div class="caption">Campanile</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.22.png" style="height: 150px; width: auto;">
                <div class="caption">Mask</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.23.png" style="height: 150px; width: auto;">
                <div class="caption">Hole to Fill</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.24.png" style="height: 150px; width: auto;">
                <div class="caption">Campanile Inpainted</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.25.png" style="height: 150px; width: auto;">
                <div class="caption">Plane View</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.26.png" style="height: 150px; width: auto;">
                <div class="caption">Mask</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.27.png" style="height: 150px; width: auto;">
                <div class="caption">Hole to Fill</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.28.png" style="height: 150px; width: auto;">
                <div class="caption">Plane View Inpainted</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.29.png" style="height: 150px; width: auto;">
                <div class="caption">Garden</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.210.png" style="height: 150px; width: auto;">
                <div class="caption">Mask</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.211.png" style="height: 150px; width: auto;">
                <div class="caption">Hole to Fill</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.212.png" style="height: 150px; width: auto;">
                <div class="caption">Garden Inpainted</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.7.3: Text-Conditional Image-to-image Translation</h2>

        <p style="text-align: left;">
            In this part, I changed the prompt to be "a photo of a family of ducks" rather than "a high quality photo".
            As the noise levels increase, the output starts to look more like the text prompt as well as the original image.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.31.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile @ noise level 1</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.32.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile @ noise level 3</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.33.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile @ noise level 5</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.34.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile @ noise level 7</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.35.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile @ noise level 10</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.36.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile @ noise level 20</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.21.png" style="height: 75px; width: auto;">
                <div class="caption">Campanile</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.37.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View @ noise level 1</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.38.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View @ noise level 3</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.39.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View @ noise level 5</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.310.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View @ noise level 7</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.311.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View @ noise level 10</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.312.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View @ noise level 20</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.25.png" style="height: 75px; width: auto;">
                <div class="caption">Plane View</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.7.313.png" style="height: 75px; width: auto;">
                <div class="caption">Garden @ noise level 1</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.314.png" style="height: 75px; width: auto;">
                <div class="caption">Garden @ noise level 3</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.315.png" style="height: 75px; width: auto;">
                <div class="caption">Garden @ noise level 5</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.316.png" style="height: 75px; width: auto;">
                <div class="caption">Garden @ noise level 7</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.317.png" style="height: 75px; width: auto;">
                <div class="caption">Garden @ noise level 10</div>
            </div>
            <div class="container">
                <img src="./media/part1.7.318.png" style="height: 75px; width: auto;">
                <div class="caption">Garden @ noise level 20</div>
            </div>
             <div class="container">
                <img src="./media/part1.7.29.png" style="height: 75px; width: auto;">
                <div class="caption">Garden</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.8: Visual Anagrams</h2>

        <p style="text-align: left;">
            In this part, I used two prompts and denoised the image with the first prompt to get the first noise estimate.
            Next, I flipped the image upside down and denoised it with the second prompt to get the second noise estimate.
            Then, I flipped the second noise estimate back and combined both these estimates by taking the average of them.
            Lastly, I used this averaged noise estimate for a reverse diffusion step to generate the visual anagram images below.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.81.png">
                <div class="caption">"An oil painting of snow on a beach"</div>
            </div>
            <div class="container">
                <img src="./media/part1.82.png">
                <div class="caption">"An oil painting of a busy city street"</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.83.png">
                <div class="caption">"A photo of a family of ducks"</div>
            </div>
            <div class="container">
                <img src="./media/part1.84.png">
                <div class="caption">"Dolphins jumping out of the water"</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.9: Hybrid Images</h2>

        <p style="text-align: left;">
            In this part, I used two prompts again and denoised the image with the first prompt to get the first noise estimate.
            Similarly, I denoised the image with the second prompt to get the second noise estimate.
            Then, I put the first noise estimate through a low pass function and the second noise estimate through a high pass function to add them and get the final noise estimate.
            Lastly, I used this final noise estimate for a reverse diffusion step to generate the hybrid images below.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.91.png">
                <div class="caption">Hybrid image of "sunset over a forest" and "an oil painting of a busy city street"</div>
            </div>
            <div class="container">
                <img src="./media/part1.92.png">
                <div class="caption">Hybrid image of "an oil painting of snow on a beach" and "dolphins jumping out of the water"</div>
            </div>
        </div>
  
    </div>

    <h2 style="margin-bottom: 50px; margin-top: 50px">Part B: Flow Matching from Scratch</h2>

    <div class="info">

        <h1 style="margin-top: 0px;">Part 1: Training a Single-Step Denoising UNet</h1>

        <h2>Part 1.1: Implementing the UNet</h2>

        <p style="text-align: left;">
            In this part, I implemented the Unconditional UNet model using the model architecture in the images below.
            As shown below, the standard UNet operations consist of Conv, DownConv, UpConv, Flatten, Unflatten, Concat, ConvBlock, DownBlock, and UpBlock.
            This model includes both downsampling blocks as well as upsampling blocks with skip connections.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb1.11.png" style="height: 350px; width: auto;">
                <div class="caption">Unconditional UNet Architecture (from project spec)</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb1.12.png" style="height: 350px; width: auto;">
                <div class="caption">Standard UNet Operations (from project spec)</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.2: Using the UNet to Train a Denoiser</h2>

        <p style="text-align: left;">
            In this part, I generated a visualization of the different noising processes over different sigma values, following the equation z = x + sigma*epsilon, where epsilon is normally distributed noise.
            We can see that as sigma increases, the image get noisier.
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/partb1.21.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.0</div>
            </div>
            <div class="container">
                <img src="./media/partb1.22.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.2</div>
            </div>
             <div class="container">
                <img src="./media/partb1.23.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.4</div>
            </div>
            <div class="container">
                <img src="./media/partb1.24.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.5</div>
            </div>
            <div class="container">
                <img src="./media/partb1.25.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.6</div>
            </div>
            <div class="container">
                <img src="./media/partb1.26.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.8</div>
            </div>
             <div class="container">
                <img src="./media/partb1.27.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=1.0</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.2.1: Training</h2>

        <p style="text-align: left;">
            In this part, I trained the Unconditional UNet on the MNIST dataset for 5 epochs using sigma=0.5, a batch size of 256, a hidden dimension of 128, and the Adam optimizer with learning rate 1e-4.
            Below is the training loss curve as well as the denoised image results after both the 1st and 5th epochs.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/part1.2.119.png" style="height: 400px; width: auto;">
            </div>
        </div>

        <p style="text-align: left;">
            After Epoch 1
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.11.png" style="height: 100px; width: auto;">
                <div class="caption">Input</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.12.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy (sigma=0.5)</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.13.png" style="height: 100px; width: auto;">
                <div class="caption">Output</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.14.png" style="height: 100px; width: auto;">
                <div class="caption">Input</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.15.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy (sigma=0.5)</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.16.png" style="height: 100px; width: auto;">
                <div class="caption">Output</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.17.png" style="height: 100px; width: auto;">
                <div class="caption">Input</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.18.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy (sigma=0.5)</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.19.png" style="height: 100px; width: auto;">
                <div class="caption">Output</div>
            </div>
        </div>

        <p style="text-align: left;">
            After Epoch 5
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.110.png" style="height: 100px; width: auto;">
                <div class="caption">Input</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.111.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy (sigma=0.5)</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.112.png" style="height: 100px; width: auto;">
                <div class="caption">Output</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.113.png" style="height: 100px; width: auto;">
                <div class="caption">Input</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.114.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy (sigma=0.5)</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.115.png" style="height: 100px; width: auto;">
                <div class="caption">Output</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.116.png" style="height: 100px; width: auto;">
                <div class="caption">Input</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.117.png" style="height: 100px; width: auto;">
                <div class="caption">Noisy (sigma=0.5)</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.118.png" style="height: 100px; width: auto;">
                <div class="caption">Output</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.2.2: Out-of-Distribution Testing</h2>

         <p style="text-align: left;">
            In this part, I generated a visualization of the different noising processes over different sigma values on the test set after the model was trained in the previous step.
            We can see that the model performs pretty well on data it was not trained for, but for large sigma values, the image does get noisier.
        </p>

        <p style="text-align: left;">
            Noisy Images
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.21.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.0</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.22.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.2</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.23.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.4</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.24.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.5</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.25.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.6</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.26.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.8</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.27.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=1.0</div>
            </div>
        </div>

        <p style="text-align: left;">
            Denoised Images
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.28.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.0</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.29.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.2</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.210.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.4</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.211.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.5</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.212.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.6</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.213.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=0.8</div>
            </div>
             <div class="container">
                <img src="./media/part1.2.214.png" style="height: 75px; width: auto;">
                <div class="caption">sigma=1.0</div>
            </div>
        </div>

        <hr />

        <h2>Part 1.2.3: Denoising Pure Noise</h2>

         <p style="text-align: left;">
            In this part, I followed the same training process as part 1.2.1, but I added pure Gaussian noise and denoised for 5 epochs.
            Below is the training loss curve as well as the denoised image results after both the 1st and 5th epochs.
            The generated outputs have similar blurry pattern that does not match any of the digits in the dataset.
            We know that with MSE loss, the model is minimizing the mean squared distances, which is associated with the centroid of the image.
            This is because denoising pure Gaussian noise results in an averaged version of this noise across all digits.
            We can see that after epoch 5, the generated outputs are more blurry and blended comapred to the outputs after epoch 1.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/part.1.2.313.png" style="height: 400px; width: auto;">
            </div>
        </div>

        <p style="text-align: left;">
            After Epoch 1
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.31.png" style="height: 100px; width: auto;">
                <div class="caption">Pure Noise</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.32.png" style="height: 100px; width: auto;">
                <div class="caption">Denoised Image</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.33.png" style="height: 100px; width: auto;">
                <div class="caption">Pure Noise</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.34.png" style="height: 100px; width: auto;">
                <div class="caption">Denoised Image</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part1.2.35.png" style="height: 100px; width: auto;">
                <div class="caption">Pure Noise</div>
            </div>
            <div class="container">
                <img src="./media/part1.2.36.png" style="height: 100px; width: auto;">
                <div class="caption">Denoised Image</div>
            </div>
        </div>

        <p style="text-align: left;">
            After Epoch 5
        </p>

        <div class="row">
            <div class="container">
                <img src="./media/part.1.2.37.png" style="height: 100px; width: auto;">
                <div class="caption">Pure Noise</div>
            </div>
            <div class="container">
                <img src="./media/part.1.2.38.png" style="height: 100px; width: auto;">
                <div class="caption">Denoised Image</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part.1.2.39.png" style="height: 100px; width: auto;">
                <div class="caption">Pure Noise</div>
            </div>
            <div class="container">
                <img src="./media/part.1.2.310.png" style="height: 100px; width: auto;">
                <div class="caption">Denoised Image</div>
            </div>
        </div>

        <div class="row">
            <div class="container">
                <img src="./media/part.1.2.311.png" style="height: 100px; width: auto;">
                <div class="caption">Pure Noise</div>
            </div>
            <div class="container">
                <img src="./media/part.1.2.312.png" style="height: 100px; width: auto;">
                <div class="caption">Denoised Image</div>
            </div>
        </div>

        <hr />

        <h1>Part 2: Training a Flow Matching Model</h1>

        <h2>Part 2.1: Adding Time Conditioning to UNet</h2>

         <p style="text-align: left;">
            In this part, I added a time scalar to the UNet model architecture.
            I followed the architecture in the images below, which includes new fully-conditioned blocks, or FCBlocks, that include this scalar t condition.
            This allows the Conditioned UNet to construct intermediate noisy samples using the relative time to the clean samples. 
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.11.png" style="height: 350px; width: auto;">
                <div class="caption">Conditioned UNet Architecture (from project spec)</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.12.png" style="height: 100px; width: auto;">
                <div class="caption">FCBlock (from project spec)</div>
            </div>
        </div>

        <hr />

        <h2>Part 2.2: Training the UNet</h2>

         <p style="text-align: left;">
            In this part, I followed Algorithm 1 below to train the time-conditioned UNet over 10 epochs.
            This essentially repeats the process of adding uniform noise to a random clean image from the training set, and the model is trained to predict the flow from the noisy image to the clean image based on the timestep.
            I used a batch size of 64, a hidden dimension of 64, the Adam optimizer with an initial learning rate of 1e-2, and an exponential learning rate delay scheduler with gamma 0.1**(1.0/num_epochs).
            Below is the training loss curve over this process.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.21.png" style="height: 150px; width: auto;">
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.22.png" style="height: 400px; width: auto;">
            </div>
        </div>

        <hr />

        <h2>Part 2.3: Sampling from the UNet</h2>

         <p style="text-align: left;">
            In this part, I follow Algorithm 2 below to sample from the time-conditioned UNet.
            The algorithm iteratively denoises pure Gaussian noise by predicting the flow at each timestep.
            Below are the results for epochs 1, 5, and 10.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.31.png" style="height: 150px; width: auto;">
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.32.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 1</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.33.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 5</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.34.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 10</div>
            </div>
        </div>

        <hr />

        <h2>Part 2.4: Adding Class-Conditioning to UNet</h2>

         <p style="text-align: left;">
            In this part, I added a condition for the class of digit to the time-conditioned UNet model architecture.
            To do this, I added 2 additional FCBlocks with one-hot vectors for the class as opposed to scalars like I did with timesteps.
            In addition, I implemented dropout so 10% of the time the one-hot vector is set to 0.
            This allows the Conditioned UNet to learn both the unconditional as well as conditional generations.
        </p>

        <hr />

        <h2>Part 2.5: Training the UNet</h2>

        <p style="text-align: left;">
            In this part, I followed Algorithm 3 below to train the class-conditioned UNet over 10 epochs.
            This is essentially the same training process as Algorithm 1 for the time-conditioned UNet, but it also conditions the model on the one-hot encoded digit class vector, with the dropout condition discussed in the previous part.
            I used the same hyperparameters as part 2.2 (a batch size of 64, a hidden dimension of 64, the Adam optimizer with an initial learning rate of 1e-2, and an exponential learning rate delay scheduler with gamma 0.1**(1.0/num_epochs)).
            Below is the training loss curve over this process.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.51.png" style="height: 150px; width: auto;">
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.52.png" style="height: 400px; width: auto;">
            </div>
        </div>

        <hr />

        <h2>Part 2.6: Sampling from the UNet</h2>

        <p style="text-align: left;">
            In this part, I follow Algorithm 4 below to sample from the class-conditioned UNet.
            The algorithm follows a similar sampling process to Algorithm 2 for the time-conditioned UNet, but it additionally uses classifier-free guidance by utilizing the conditional and unconditional generations. 
            Below are the results for epochs 1, 5, and 10.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.6.1.png" style="height: 150px; width: auto;">
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.62.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 1</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.63.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 5</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.64.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 10</div>
            </div>
        </div>

        <p style="text-align: left;">
            To get rid of the learning rate scheduler while maintaining the same performance, I reduced the overall learning rate to be lower than the initial learning rate of 1e-2, since the learning rate scheduler slowly decreases the learning rate across epochs.
            Specifically, I reduced the learning rate to 1e-3, which is between the initial and final learning rates from the scheduler.
            Below is the training loss curve over this process without the scheduler, as well as the results for epochs 1, 5, and 10.
        </p>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.68.png" style="height: 400px; width: auto;">
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.65.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 1</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.66.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 5</div>
            </div>
        </div>

        <div class="row">
            <div class="stack-image-container">
                <img src="./media/partb2.67.png" style="height: 300px; width: auto;">
                <div class="caption">Epoch 10</div>
            </div>
        </div>


    </div>

    <h2 style="margin-bottom: 50px; margin-top: 50px">Conclusion</h2>
    <div class="info">
        <p style="text-align: left;">
            The most important thing I learned from this project was the importance of conditioning when designing generative models.
            In particular, as shown in part B, adding the time and class conditioning significantly improved the quality of the samples the model generated.
            Overall, it was interesting to be able to see the inner workings of diffusion models, specifically how denoising, conditioning, and hyperparameters play a role in producing good results.
        </p>
    </div>

</body>
</html>
